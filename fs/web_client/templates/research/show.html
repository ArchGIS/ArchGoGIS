<div class="content">
  <h2><%= t('research.singular') %> "<%= maybe(research, "Нет названия", "name") %>"</h2>

  <div id="container">
    <ul>
      <li><a href="#common"><%= t('common.general') %></a></li>
      <li><a href="#monuments"><%= t('monument.plural') %></a></li>
      <li><a href="#heritages"><%= t('heritage.singular') %></a></li>
      <li><a href="#excavations"><%= t('excavation.plural') %></a></li>
      <li><a href="#topos"><%= t('topoplan.plural') %></a></li>
      <li><a href="#artifacts"><%= t('artifact.plural') %></a></li>
      <li><a href="#another">*</a></li>
    </ul>

    <div id="common">
      <dl>
        <dt><%= t('author.singular') %>:</dt>
        <dd><a href="#author/show/<%= author[0].id %>">
          <%= author[0].name %>
        </a></dd>

        <% if (coauthors.length) { %>
          <dt><%= t('coauthor.plural') %>:</dt>
          <% _.each(coauthors, function(a, i) { %>
            <dd><a href="#author/show/<%= a.id %>"><%= a.name %></a></dd>
          <% }); %>
        <% } %>

        <dt><%= t('research.year') %>:</dt>
        <dd><%= maybe(research, "Не указан", "year") %></dd>

        <dt><%= t('research.type') %>:</dt>
        <dd><%= maybe(resType[0], "Не указано", "name") %></dd>

        <dt><%= t('research.prop.description') %>:</dt>
        <dd><%= maybe(research, "Отсутствует", "description" ) %></dd>
        
        <dt><%= t('report.singular') %>:</dt>
        <dd>
          <% if (reports.length) { %>
            <div>
            <% _.each(reports, function(report, i) { %>
              <% var reportTitle = `${maybe(reports[i], "Нет названия", "name")} (${maybe(author[i], "автор неизвестен", "name")}, ${maybe(reports[i], "год не указан", "year")})` %>
              <% if (reports[i].fileid) { %>
                <%= App.models.Report.href(reports[i].id, reportTitle) %>
              <% } else {%>
                <%= reportTitle %>
              <% } %>
              <br>
            <% }); %>
            </div>
          <% } else { %>
              Нет отчёта
          <% } %>
        </dd>

        <dt><%= t("monument.count") %>:</dt>
        <dd><%= _.size(monuments) %></dd>

        <% if (resType[0].name === 'Раскопки' || resType[0].name === 'Разведка') { %>
          <dt><%= t("excavation.genitivePl") %>:</dt>
          <dd><%= _.reduce(excavations, function(size, list) {
            return size + _.size(list)
          }, 0) %>;
          Общая площадь
          <%= _.reduce(excavations, function(area, list) {
            return area + _.reduce(list, function(area, exc) {
              return area + (exc.area || 0);
            }, 0);
          }, 0) %>
          м²</dd>
        <% } %>

        <dt><%= t("artifact.genitivePl") %>:</dt>
        <dd>
          <% let artiCount = _.reduce(artifacts, (count, resArti) => {return count + _.size(resArti)}, 0) %>
          <%= artiCount %>
        </dd>
      </dl>
    </div>

    <div id="monuments">
      <div id="accordion">
        <% var counter = 1 %>
        <% _.each(monuments, function(monument, i) { %>
          
          <h4 class="accordion-header">
            <span class="ui-accordion-header-icon ui-icon ui-icon-triangle-1-e"></span>
            <%= t('monument.singular') %> №<%= counter++ %>: <b><%= knowledges[i].monument_name %></b>
          </h4>
          
          <div class="accordion-content">
            <dl>
              <dt></dt>
              <dd>
                <a href="#monument/show/<%= monument.id %>">
                Перейти к памятнику
              </a>
              </dd>
              <dt>Название, данное исследователем:</dt>
              <dd><%= knowledges[i].monument_name %></dd>
              <dt>Эпоха:</dt>
              <dd><%= maybe(epochs[i][0], "Нет данных", "name") %></dd>
              <dt>Тип:</dt>
              <dd><%= maybe(monTypes[i][0], "Нет данных", "name") %></dd>
              <dt>Культурная принадлежность, определенная исследователем:</dt>
              <dd><%= maybe(cultures[i][0], "Нет данных", "name") %></dd>
              <% if (knowledges[i].description) { %>
                <dt>Описание памятника:</dt>
                <dd><%= knowledges[i].description %></dd>
              <% } %>
              <dt>Найденные артефакты:</dt>
              <dd>
                <% if (artifacts[i] && artifacts[i].length > 0) { %>
                  <% var length = artifacts[i].length %>
                  <% _.each(artifacts[i], function(artifact, i) { %>
                    <a href="#artifact/show/<%= artifact.id %>">
                      <%= artifact.name%>
                    </a>
                    <% if (i < length-1) { %>
                    ,
                  <% } %>
                <% }); %>
                <% } else { %>
                  нет
                <% } %>
              </dd>

              <dt>Археологические вскрытия:</dt>
              <dd>
                <% if (excavations[i] && excavations[i].length > 0) { %>
                  <% var length = excavations[i].length %>
                  <% _.each(excavations[i], function(excavation, i) { %>
                    <%= maybe(excavation, `без названия ${i}`, "name")%>
                    <% if (excavation.area) { %>
                      (<%= excavation.area%> м²)
                    <% } %>
                    <% if (i < length-1) { %>
                    ,
                    <% } %>
                  <% }); %>
                <% } else { %>
                  нет
                <% } %>
              </dd>
            </dl>
          </div>

        <% }) %>
      </div>
    </div>

    <div id="artifacts">
      <% if (artiCount) { %>
        <dl>
          <dt>Найденные артефакты:</dt>
          <dd>
            <%= _.compact(_.map(artifacts, function(arti, i) {
              let title = `${arti.name} (${author[0].name}, ${research.year})`;
              return App.models.Artifact.href(arti.id, title);
            })).join(", <br>") %>
          </dd>
        </dl>
      <% } %>
    </div>

    <div id="heritages">
      <% 
      let hs = [];
      if (heritages.length) {
        _.each(heritages, (her) => {
          if (her && her.heritage && her.heritage[0]) {
            hs.push(App.models.Heritage.href(her.heritage[0].id, her.heritage[0].name))
          }
        })
      } %>
      <%= _.uniq(hs).join("<br>") %>
    </div>

    <div id="excavations"> 
      <% 
      let excs = [];
      _.each(excavations, function(resExc, i) {
        _.each(resExc.excavations, function(exc, t) {
          let area = exc.area || 0;
          let name = exc.name || "без названия";
          let boss = exc.boss || "неизвестен";
          excs.push(
            App.models.Excavation.href(exc.id, `
              ${name} - ${area}м² (${author[0].name}, ${research.year}), руководитель работ: ${boss}
            `)
          );
        })
      })
      %>
      <%= _.uniq(excs).join("<br>") %>
    </div>

    <div id="topos">
      <%= (topos[0]) ? App.views.functions.getTopoCard(topos[0]) : "" %>
    </div>

    <div id="another">
      Заглушка для будущих вкладок
    </div>
  </div>
</div>


<div id="map" class="maps">
</div>